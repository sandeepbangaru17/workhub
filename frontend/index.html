<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>WorkHub ‚Ä¢ Premium Dashboard</title>

  <!-- Premium font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg0:#050815;
      --bg1:#070b1c;
      --glass: rgba(255,255,255,.06);
      --glass2: rgba(255,255,255,.085);
      --stroke: rgba(255,255,255,.10);
      --stroke2: rgba(255,255,255,.14);
      --text:#eef2ff;
      --muted: rgba(238,242,255,.72);
      --muted2: rgba(238,242,255,.52);
      --brand:#38bdf8;
      --brand2:#a78bfa;
      --ok:#34d399;
      --bad:#fb7185;
      --warn:#fbbf24;

      --shadow: 0 20px 60px rgba(0,0,0,.45);
      --shadow2: 0 14px 30px rgba(0,0,0,.30);
      --r1: 22px;
      --r2: 16px;
      --r3: 14px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 10% 10%, rgba(56,189,248,.18), transparent 55%),
        radial-gradient(900px 650px at 92% 18%, rgba(167,139,250,.18), transparent 50%),
        radial-gradient(900px 650px at 35% 95%, rgba(52,211,153,.10), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    /* subtle noise */
    body:before{
      content:"";
      position:fixed; inset:0;
      pointer-events:none;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='220' height='220'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.85' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='220' height='220' filter='url(%23n)' opacity='.12'/%3E%3C/svg%3E");
      mix-blend-mode: overlay;
      opacity:.26;
    }

    a{ color:inherit; text-decoration:none; }

    .wrap{
      max-width: 1240px;
      margin: 0 auto;
      padding: 26px 18px 70px;
      position:relative;
    }

    /* Topbar */
    .topbar{
      position:sticky;
      top:14px;
      z-index:20;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      padding: 14px 14px;
      border-radius: var(--r1);
      border: 1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      backdrop-filter: blur(14px);
      box-shadow: var(--shadow2);
    }

    .brand{
      display:flex; align-items:center; gap:12px;
      min-width: 280px;
    }
    .logo{
      width:44px; height:44px;
      border-radius: 16px;
      background: linear-gradient(135deg, rgba(56,189,248,.95), rgba(167,139,250,.92));
      box-shadow: 0 14px 34px rgba(56,189,248,.18);
      display:grid; place-items:center;
      font-weight: 900;
      letter-spacing: .5px;
      color:#041022;
      user-select:none;
    }
    .brandTitle{
      display:flex; flex-direction:column; gap:2px;
    }
    .brandTitle .t{
      font-size: 14px;
      font-weight: 900;
      letter-spacing: .2px;
      margin:0;
    }
    .brandTitle .s{
      margin:0;
      font-size: 12px;
      color: var(--muted);
    }

    .right{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      justify-content:flex-end;
    }
    .chip{
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,.14);
      padding: 9px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: var(--muted);
      display:inline-flex; align-items:center; gap:8px;
      white-space: nowrap;
    }
    .dot{
      width:8px; height:8px; border-radius:99px; display:inline-block;
      background: rgba(255,255,255,.25);
      box-shadow: 0 0 0 3px rgba(255,255,255,.06);
    }
    .dot.ok{ background: rgba(52,211,153,.92); box-shadow: 0 0 0 3px rgba(52,211,153,.14); }
    .dot.bad{ background: rgba(251,113,133,.92); box-shadow: 0 0 0 3px rgba(251,113,133,.14); }

    .btn{
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      cursor:pointer;
      transition: transform .14s ease, background .14s ease, border-color .14s ease;
      font-weight: 800;
      letter-spacing: .1px;
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.09); border-color: var(--stroke2); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; transform:none; }

    .btn.primary{
      border-color: rgba(56,189,248,.35);
      background: linear-gradient(135deg, rgba(56,189,248,.18), rgba(167,139,250,.14));
    }
    .btn.ghost{
      background: rgba(0,0,0,.18);
    }
    .btn.danger{
      border-color: rgba(251,113,133,.38);
      background: rgba(251,113,133,.12);
    }

    /* Layout */
    .grid{
      margin-top: 18px;
      display:grid;
      grid-template-columns: 400px 1fr;
      gap: 16px;
      align-items: start;
    }
    @media (max-width: 1040px){
      .grid{ grid-template-columns: 1fr; }
      .topbar{ position:relative; top:0; }
      .brand{ min-width: unset; }
    }

    .card{
      border-radius: var(--r1);
      border: 1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(12px);
    }
    .hd{
      padding: 16px 16px 12px;
      border-bottom: 1px solid var(--stroke);
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      background: rgba(255,255,255,.03);
    }
    .hd h2{
      margin:0;
      font-size: 14px;
      letter-spacing: .1px;
      font-weight: 900;
    }
    .hd p{
      margin: 6px 0 0;
      font-size: 12px;
      line-height: 1.45;
      color: var(--muted);
    }
    .bd{ padding: 16px; }

    .tabs{
      display:flex; gap:8px; flex-wrap:wrap;
      padding: 12px 16px 0;
    }
    .tab{
      font-size: 12px;
      color: var(--muted);
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,.16);
      padding: 9px 10px;
      border-radius: 999px;
      cursor:pointer;
      transition: .14s ease;
      user-select:none;
      font-weight: 800;
    }
    .tab:hover{ border-color: var(--stroke2); }
    .tab.active{
      color: var(--text);
      border-color: rgba(56,189,248,.40);
      background: linear-gradient(135deg, rgba(56,189,248,.16), rgba(167,139,250,.12));
    }

    .row{ display:flex; gap:10px; }
    .row > *{ flex:1; }
    .field{ display:flex; flex-direction:column; gap:7px; margin-bottom:12px; }
    .field label{
      font-size: 12px;
      color: var(--muted);
      font-weight: 700;
      letter-spacing: .1px;
    }
    input, select, textarea{
      width:100%;
      background: rgba(0,0,0,.20);
      border: 1px solid var(--stroke);
      border-radius: 14px;
      padding: 11px 12px;
      color: var(--text);
      outline:none;
      font-size: 13px;
      transition: border-color .14s ease, background .14s ease;
    }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(56,189,248,.40);
      background: rgba(0,0,0,.26);
    }
    textarea{ min-height: 90px; resize: vertical; }
    ::placeholder{ color: rgba(238,242,255,.35); }

    .hr{ height:1px; background: var(--stroke); margin: 14px 0; }

    .msg{
      margin-top: 10px;
      border-radius: 16px;
      padding: 11px 12px;
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,.18);
      font-size: 13px;
      color: var(--muted);
      line-height:1.45;
    }
    .msg.ok{ border-color: rgba(52,211,153,.35); background: rgba(52,211,153,.10); color: rgba(214,255,236,.92); }
    .msg.bad{ border-color: rgba(251,113,133,.40); background: rgba(251,113,133,.10); color: rgba(255,218,225,.92); }

    /* List */
    .list{
      display:flex; flex-direction:column; gap:12px;
    }
    .item{
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      border-radius: var(--r2);
      padding: 14px;
      display:flex;
      gap: 12px;
      align-items:flex-start;
      justify-content:space-between;
      transition: transform .14s ease, border-color .14s ease, background .14s ease;
    }
    .item:hover{
      transform: translateY(-1px);
      border-color: var(--stroke2);
      background: rgba(255,255,255,.07);
    }
    .titleRow{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .item h3{
      margin:0;
      font-size: 13px;
      font-weight: 900;
      letter-spacing:.1px;
    }
    .item p{
      margin: 6px 0 0;
      font-size: 12px;
      color: var(--muted);
      line-height:1.45;
    }

    .actions{
      display:flex; align-items:center; justify-content:flex-end;
      gap: 8px; flex-wrap:wrap;
      min-width: 190px;
    }

    .badge{
      display:inline-flex; align-items:center; gap:7px;
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,.16);
      border-radius: 999px;
      padding: 7px 10px;
      font-size: 12px;
      color: var(--muted);
      font-weight: 800;
      white-space: nowrap;
    }
    .badge.ok{ border-color: rgba(52,211,153,.34); color: rgba(214,255,236,.92); background: rgba(52,211,153,.10); }
    .badge.bad{ border-color: rgba(251,113,133,.40); color: rgba(255,218,225,.92); background: rgba(251,113,133,.10); }
    .badge.warn{ border-color: rgba(251,191,36,.38); color: rgba(255,245,210,.92); background: rgba(251,191,36,.10); }
    .badge.brand{ border-color: rgba(56,189,248,.35); color: rgba(220,251,255,.95); background: rgba(56,189,248,.10); }

    .muted{ color: var(--muted); font-size: 12px; }
    .hint{ color: var(--muted2); font-size: 12px; }

    /* Rating row */
    .rateRow{
      margin-top: 10px;
      display:flex;
      gap: 8px;
      flex-wrap:wrap;
      align-items:center;
      padding: 10px;
      border: 1px dashed rgba(255,255,255,.14);
      border-radius: 16px;
      background: rgba(0,0,0,.12);
    }
    .rateRow select, .rateRow input{
      padding: 10px 11px;
      border-radius: 14px;
      border-color: rgba(255,255,255,.12);
    }
    .rateRow input{
      flex: 1;
      min-width: 180px;
    }

    /* Header actions in browse */
    .browseControls{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }

    /* small */
    .kpi{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.14);
      border-radius: 999px;
      padding: 9px 10px;
      font-size: 12px;
      color: var(--muted);
      font-weight: 800;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">WH</div>
        <div class="brandTitle">
          <p class="t">WorkHub</p>
          <p class="s">Premium dashboard ‚Ä¢ Businesses ‚áÑ Workers ‚Ä¢ Vizag-first</p>
        </div>
      </div>

      <div class="right">
        <div class="chip" id="healthPill"><span class="dot"></span> API: checking‚Ä¶</div>
        <div class="chip" id="whoPill">Not logged in</div>
        <button class="btn ghost" id="btnRefresh">Refresh</button>
        <button class="btn danger" id="btnLogout" disabled>Logout</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <div class="hd">
          <div>
            <h2>Account & Tools</h2>
            <p>Login/register, worker profile controls, owner business panel.</p>
          </div>
        </div>

        <div class="tabs">
          <div class="tab active" data-tab="login">Login</div>
          <div class="tab" data-tab="register">Register</div>
          <div class="tab" data-tab="profile">Worker</div>
          <div class="tab" data-tab="owner">Owner</div>
        </div>

        <div class="bd">
          <!-- LOGIN -->
          <div class="panel" id="panel-login">
            <div class="field">
              <label>Email</label>
              <input id="loginEmail" placeholder="name@example.com"/>
            </div>
            <div class="field">
              <label>Password</label>
              <input id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/>
            </div>
            <div class="row">
              <button class="btn primary" id="btnLogin">Login</button>
              <button class="btn" id="btnQuickAdmin">Use Admin Demo</button>
            </div>
            <div class="msg" id="loginMsg" style="display:none;"></div>

            <div class="hr"></div>
            <div class="hint">Admin demo: <b>admin@workhub.local</b> / <b>admin123</b></div>
          </div>

          <!-- REGISTER -->
          <div class="panel" id="panel-register" style="display:none;">
            <div class="field">
              <label>Role</label>
              <select id="regRole">
                <option value="owner">Business Owner</option>
                <option value="worker">Worker</option>
              </select>
            </div>

            <div class="field">
              <label>Name</label>
              <input id="regName" placeholder="Full name"/>
            </div>

            <div class="row">
              <div class="field">
                <label>Email</label>
                <input id="regEmail" placeholder="name@example.com"/>
              </div>
              <div class="field">
                <label>Phone (optional)</label>
                <input id="regPhone" placeholder="98765‚Ä¶"/>
              </div>
            </div>

            <div class="field">
              <label>Password</label>
              <input id="regPass" type="password" placeholder="Minimum 4 characters"/>
            </div>

            <button class="btn primary" id="btnRegister">Create account</button>
            <div class="msg" id="regMsg" style="display:none;"></div>
          </div>

          <!-- WORKER -->
          <div class="panel" id="panel-profile" style="display:none;">
            <div class="muted" style="margin-bottom:10px;">
              Worker profile: keep it clean and searchable.
            </div>

            <div class="field">
              <label>Skills (comma separated)</label>
              <input id="wpSkills" placeholder="Plumber, Electrician, Painter‚Ä¶"/>
            </div>

            <div class="row">
              <div class="field">
                <label>Experience (years)</label>
                <input id="wpExp" type="number" min="0" value="0"/>
              </div>
              <div class="field">
                <label>Location</label>
                <input id="wpLoc" placeholder="Vizag / Gajuwaka / MVP‚Ä¶"/>
              </div>
            </div>

            <button class="btn primary" id="btnSaveProfile">Save profile</button>

            <div class="hr"></div>

            <div class="field">
              <label>Availability status</label>
              <select id="wpStatus">
                <option value="pending">Pending</option>
                <option value="ready">Ready</option>
                <option value="busy">Busy</option>
              </select>
            </div>

            <button class="btn" id="btnSetStatus">Update status</button>

            <div class="msg" id="wpMsg" style="display:none;"></div>
          </div>

          <!-- OWNER -->
          <div class="panel" id="panel-owner" style="display:none;">
            <div class="muted" style="margin-bottom:10px;">
              Owner: create businesses and approve worker join requests.
            </div>

            <div class="field">
              <label>Business name</label>
              <input id="bizName" placeholder="e.g., Sri Lakshmi Constructions"/>
            </div>

            <div class="row">
              <div class="field">
                <label>Category</label>
                <input id="bizCat" placeholder="Construction / Hotel / Retail‚Ä¶"/>
              </div>
              <div class="field">
                <label>Location</label>
                <input id="bizLoc" placeholder="Vizag"/>
              </div>
            </div>

            <button class="btn primary" id="btnCreateBiz">Create business</button>

            <div class="hr"></div>

            <div class="row">
              <button class="btn" id="btnLoadRequests">Load pending requests</button>
              <button class="btn ghost" id="btnGoBusinesses">Open Businesses</button>
            </div>

            <div class="msg" id="ownerMsg" style="display:none;"></div>

            <div class="hr"></div>
            <div class="list" id="requestList"></div>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <div class="hd">
          <div>
            <h2>Browse</h2>
            <p>Businesses and workers with filters + ratings. One clean view.</p>
          </div>
          <div class="browseControls">
            <div class="kpi" id="countBadge">0 items</div>
            <button class="btn primary" id="btnBusinesses">Businesses</button>
            <button class="btn" id="btnWorkers">Workers</button>
          </div>
        </div>

        <div class="bd">
          <div class="row" style="align-items:flex-end;">
            <div class="field" style="margin:0;">
              <label>Business filter (for workers)</label>
              <select id="filterBusiness">
                <option value="">All businesses</option>
              </select>
            </div>
            <div class="field" style="margin:0;">
              <label>Status filter</label>
              <select id="filterStatus">
                <option value="">All</option>
                <option value="ready">Ready</option>
                <option value="busy">Busy</option>
                <option value="pending">Pending</option>
              </select>
            </div>
          </div>

          <div class="hr"></div>
          <div class="list" id="list"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const api = (path, opts={}) =>
      fetch(path, { headers: { "Content-Type": "application/json" }, ...opts })
        .then(async r => {
          const data = await r.json().catch(() => ({}));
          if (!r.ok) throw new Error(data.error || ("Request failed: " + r.status));
          return data;
        });

    const el = id => document.getElementById(id);
    const state = { user: null, view: "businesses", businesses: [] };

    function escapeHtml(str){
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function setMsg(target, text, type="") {
      const box = el(target);
      box.style.display = "block";
      box.className = "msg " + (type || "");
      box.textContent = text;
    }
    function hideMsg(target){
      const box = el(target);
      box.style.display = "none";
      box.textContent = "";
      box.className = "msg";
    }

    function roleName(role){
      if (role === "admin") return "Admin";
      if (role === "owner") return "Owner";
      if (role === "worker") return "Worker";
      return role;
    }

    function updateTop() {
      el("btnLogout").disabled = !state.user;
      el("whoPill").textContent = state.user
        ? `${roleName(state.user.role)} ‚Ä¢ ${state.user.name} (id:${state.user.id})`
        : "Not logged in";
    }

    function setHealth(ok){
      const pill = el("healthPill");
      pill.innerHTML = ok
        ? `<span class="dot ok"></span> API: OK`
        : `<span class="dot bad"></span> API: DOWN`;
    }

    function showTab(key){
      document.querySelectorAll(".tab").forEach(t => {
        t.classList.toggle("active", t.dataset.tab === key);
      });
      ["login","register","profile","owner"].forEach(k => {
        el("panel-"+k).style.display = (k === key) ? "block" : "none";
      });
    }
    document.querySelectorAll(".tab").forEach(t => {
      t.addEventListener("click", () => showTab(t.dataset.tab));
    });

    // Health
    async function checkHealth(){
      try{
        await api("/api/health");
        setHealth(true);
      }catch(e){
        setHealth(false);
      }
    }

    // Auth
    el("btnQuickAdmin").addEventListener("click", () => {
      el("loginEmail").value = "admin@workhub.local";
      el("loginPass").value = "admin123";
    });

    el("btnLogin").addEventListener("click", async () => {
      hideMsg("loginMsg");
      try{
        const email = el("loginEmail").value.trim();
        const password = el("loginPass").value;

        const data = await api("/api/login", {
          method:"POST",
          body: JSON.stringify({ email, password })
        });

        state.user = data.user;
        setMsg("loginMsg", "Logged in successfully.", "ok");
        updateTop();

        if (state.user.role === "owner") showTab("owner");
        else if (state.user.role === "worker") showTab("profile");
        else showTab("login");

        await refreshAll();
      }catch(e){
        setMsg("loginMsg", e.message, "bad");
      }
    });

    el("btnRegister").addEventListener("click", async () => {
      hideMsg("regMsg");
      try{
        const role = el("regRole").value;
        const name = el("regName").value.trim();
        const email = el("regEmail").value.trim();
        const phone = el("regPhone").value.trim();
        const password = el("regPass").value;

        const data = await api("/api/register", {
          method:"POST",
          body: JSON.stringify({ role, name, email, phone, password })
        });

        setMsg("regMsg", `Account created for ${data.user.name}. Now login.`, "ok");
      }catch(e){
        setMsg("regMsg", e.message, "bad");
      }
    });

    el("btnLogout").addEventListener("click", () => {
      state.user = null;
      updateTop();
      showTab("login");
      refreshAll();
    });

    // Worker
    el("btnSaveProfile").addEventListener("click", async () => {
      hideMsg("wpMsg");
      try{
        if (!state.user || state.user.role !== "worker") throw new Error("Login as a Worker first.");
        const skills = el("wpSkills").value.trim();
        const experience_years = Number(el("wpExp").value || 0);
        const location = el("wpLoc").value.trim();

        await api("/api/worker/profile", {
          method:"POST",
          body: JSON.stringify({ user_id: state.user.id, skills, experience_years, location })
        });

        setMsg("wpMsg", "Profile saved.", "ok");
        await refreshWorkers();
      }catch(e){
        setMsg("wpMsg", e.message, "bad");
      }
    });

    el("btnSetStatus").addEventListener("click", async () => {
      hideMsg("wpMsg");
      try{
        if (!state.user || state.user.role !== "worker") throw new Error("Login as a Worker first.");
        const status = el("wpStatus").value;

        await api("/api/worker/status", {
          method:"POST",
          body: JSON.stringify({ user_id: state.user.id, status })
        });

        setMsg("wpMsg", "Status updated.", "ok");
        await refreshWorkers();
      }catch(e){
        setMsg("wpMsg", e.message, "bad");
      }
    });

    // Owner
    el("btnCreateBiz").addEventListener("click", async () => {
      hideMsg("ownerMsg");
      try{
        if (!state.user || state.user.role !== "owner") throw new Error("Login as an Owner first.");

        const name = el("bizName").value.trim();
        const category = el("bizCat").value.trim();
        const location = el("bizLoc").value.trim();

        const data = await api("/api/owner/businesses", {
          method:"POST",
          body: JSON.stringify({ owner_id: state.user.id, name, category, location })
        });

        setMsg("ownerMsg", `Business created: ${data.business.name}`, "ok");
        el("bizName").value = "";
        await refreshBusinesses();
        if (state.view === "businesses") renderBusinesses();
      }catch(e){
        setMsg("ownerMsg", e.message, "bad");
      }
    });

    el("btnLoadRequests").addEventListener("click", async () => {
      hideMsg("ownerMsg");
      try{
        if (!state.user || state.user.role !== "owner") throw new Error("Login as an Owner first.");
        const data = await api(`/api/owner/pending_requests?owner_id=${state.user.id}`);
        renderRequests(data.items || []);
        setMsg("ownerMsg", `Loaded ${data.items.length} pending request(s).`, "ok");
      }catch(e){
        setMsg("ownerMsg", e.message, "bad");
      }
    });

    el("btnGoBusinesses").addEventListener("click", async () => {
      state.view = "businesses";
      await refreshBusinesses();
      renderBusinesses();
    });

    function renderRequests(items){
      const box = el("requestList");
      box.innerHTML = "";
      if (!items.length){
        box.innerHTML = `<div class="muted">No pending requests.</div>`;
        return;
      }

      items.forEach(it => {
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <div>
            <div class="titleRow">
              <h3>${escapeHtml(it.worker_name)}</h3>
              <span class="badge warn">Pending</span>
            </div>
            <p>
              Business: <b>${escapeHtml(it.business_name)}</b><br/>
              Email: ${escapeHtml(it.email || "-")} ‚Ä¢ Phone: ${escapeHtml(it.phone || "-")}
            </p>
          </div>
          <div class="actions">
            <button class="btn primary" data-approve="${it.request_id}">Approve</button>
          </div>
        `;
        box.appendChild(div);
      });

      box.querySelectorAll("[data-approve]").forEach(btn => {
        btn.addEventListener("click", async () => {
          try{
            btn.disabled = true;
            const request_id = Number(btn.dataset.approve);
            await api("/api/owner/approve_request", {
              method:"POST",
              body: JSON.stringify({ owner_id: state.user.id, request_id })
            });

            setMsg("ownerMsg", "Request approved.", "ok");
            const data = await api(`/api/owner/pending_requests?owner_id=${state.user.id}`);
            renderRequests(data.items || []);
          }catch(e){
            setMsg("ownerMsg", e.message, "bad");
          }finally{
            btn.disabled = false;
          }
        });
      });
    }

    // Browse
    el("btnBusinesses").addEventListener("click", async () => {
      state.view = "businesses";
      await refreshBusinesses();
      renderBusinesses();
    });

    el("btnWorkers").addEventListener("click", async () => {
      state.view = "workers";
      await refreshWorkers();
    });

    el("btnRefresh").addEventListener("click", refreshAll);

    el("filterBusiness").addEventListener("change", () => {
      if (state.view === "workers") refreshWorkers();
    });
    el("filterStatus").addEventListener("change", () => {
      if (state.view === "workers") refreshWorkers();
    });

    // Data
    async function refreshBusinesses(){
      const data = await api("/api/businesses");
      state.businesses = data.items || [];
      const sel = el("filterBusiness");
      const keep = sel.value;

      sel.innerHTML = `<option value="">All businesses</option>` + state.businesses.map(b =>
        `<option value="${b.id}">${escapeHtml(b.name)} ‚Ä¢ ${escapeHtml(b.location || "‚Äî")}</option>`
      ).join("");

      sel.value = keep || "";
    }

    function statusBadge(s){
      if (s === "ready") return `<span class="badge ok">Ready</span>`;
      if (s === "busy") return `<span class="badge bad">Busy</span>`;
      return `<span class="badge warn">Pending</span>`;
    }

    function stars(avg){
      const a = Number(avg || 0);
      const full = Math.max(0, Math.min(5, Math.round(a)));
      return "‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ".slice(0, full) + "‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ".slice(0, 5-full);
    }

    function renderBusinesses(){
      const box = el("list");
      box.innerHTML = "";
      const items = state.businesses;
      el("countBadge").textContent = `${items.length} businesses`;

      if (!items.length){
        box.innerHTML = `<div class="muted">No businesses yet. Create one as an Owner.</div>`;
        return;
      }

      items.forEach(b => {
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <div>
            <div class="titleRow">
              <h3>${escapeHtml(b.name)}</h3>
              <span class="badge brand">${escapeHtml(b.category || "Business")}</span>
            </div>
            <p>
              Location: ${escapeHtml(b.location || "‚Äî")}<br/>
              Owner: ${escapeHtml(b.owner_name || "‚Äî")}
            </p>
          </div>
          <div class="actions">
            ${state.user && state.user.role === "worker"
              ? `<button class="btn primary" data-join="${b.id}">Request to Join</button>`
              : `<span class="badge">Browse</span>`
            }
          </div>
        `;
        box.appendChild(div);
      });

      box.querySelectorAll("[data-join]").forEach(btn => {
        btn.addEventListener("click", async () => {
          try{
            if (!state.user || state.user.role !== "worker") throw new Error("Login as a Worker first.");
            btn.disabled = true;

            const business_id = Number(btn.dataset.join);
            await api("/api/worker/register_business", {
              method:"POST",
              body: JSON.stringify({ worker_user_id: state.user.id, business_id })
            });

            alert("Request sent to owner for approval.");
          }catch(e){
            alert(e.message);
          }finally{
            btn.disabled = false;
          }
        });
      });
    }

    async function refreshWorkers(){
      const box = el("list");
      box.innerHTML = `<div class="muted">Loading workers‚Ä¶</div>`;

      const status = el("filterStatus").value;
      const business_id = el("filterBusiness").value;

      const qs = new URLSearchParams();
      if (status) qs.set("status", status);
      if (business_id) qs.set("business_id", business_id);

      try{
        const data = await api(`/api/workers?${qs.toString()}`);
        const items = data.items || [];
        el("countBadge").textContent = `${items.length} workers`;
        renderWorkers(items);
      }catch(e){
        box.innerHTML = `<div class="msg bad">${escapeHtml(e.message)}</div>`;
      }
    }

    function renderWorkers(items){
      const box = el("list");
      box.innerHTML = "";

      if (!items.length){
        box.innerHTML = `<div class="muted">No workers found for current filters.</div>`;
        return;
      }

      items.forEach(w => {
        const div = document.createElement("div");
        div.className = "item";

        const avg = Number(w.avg_rating || 0).toFixed(1);
        const cnt = Number(w.rating_count || 0);

        div.innerHTML = `
          <div>
            <div class="titleRow">
              <h3>${escapeHtml(w.name)}</h3>
              ${statusBadge(w.status)}
              <span class="badge brand">${stars(avg)} ‚Ä¢ ${escapeHtml(avg)} (${escapeHtml(cnt)})</span>
            </div>

            <p>
              Skills: ${escapeHtml(w.skills || "‚Äî")}<br/>
              Exp: ${escapeHtml(String(w.experience_years ?? 0))} yrs ‚Ä¢ Location: ${escapeHtml(w.location || "‚Äî")}
            </p>

            ${state.user ? `
              <div class="rateRow">
                <select data-rate-stars="${w.user_id}">
                  <option value="5">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ (5)</option>
                  <option value="4">‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ (4)</option>
                  <option value="3">‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ (3)</option>
                  <option value="2">‚òÖ‚òÖ‚òÜ‚òÜ‚òÜ (2)</option>
                  <option value="1">‚òÖ‚òÜ‚òÜ‚òÜ‚òÜ (1)</option>
                </select>
                <input data-rate-text="${w.user_id}" placeholder="Write a short review (optional)" />
                <button class="btn primary" data-rate-btn="${w.user_id}">Rate</button>
              </div>
            ` : `<div class="hint" style="margin-top:10px;">Login to rate workers.</div>`}
          </div>

          <div class="actions">
            <span class="badge">üìû ${escapeHtml(w.phone || "‚Äî")}</span>
            <span class="badge">‚úâÔ∏è ${escapeHtml(w.email || "‚Äî")}</span>
          </div>
        `;
        box.appendChild(div);
      });

      // rating handlers
      box.querySelectorAll("[data-rate-btn]").forEach(btn => {
        btn.addEventListener("click", async () => {
          try{
            if (!state.user) throw new Error("Login required to rate.");

            const workerId = Number(btn.dataset.rateBtn);
            const starsEl = box.querySelector(`[data-rate-stars="${workerId}"]`);
            const textEl = box.querySelector(`[data-rate-text="${workerId}"]`);

            const rating = Number(starsEl.value);
            const review = (textEl.value || "").trim();

            btn.disabled = true;
            await api("/api/ratings", {
              method: "POST",
              body: JSON.stringify({
                worker_user_id: workerId,
                rater_user_id: state.user.id,
                rating,
                review
              })
            });

            alert("Rating submitted.");
            await refreshWorkers();
          }catch(e){
            alert(e.message);
          }finally{
            btn.disabled = false;
          }
        });
      });
    }

    async function refreshAll(){
      await checkHealth();
      await refreshBusinesses();
      if (state.view === "businesses") renderBusinesses();
      else await refreshWorkers();
      updateTop();
    }

    // init
    (async function init(){
      await refreshAll();
      state.view = "businesses";
    })();
  </script>
</body>
</html>
