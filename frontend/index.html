<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WorkHub ‚Ä¢ Connect Businesses & Workers</title>

  <style>
    :root{
      --bg:#0b1220;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.08);
      --line:rgba(255,255,255,.10);
      --text:#eaf0ff;
      --muted:rgba(234,240,255,.70);
      --brand:#6ee7ff;
      --brand2:#a78bfa;
      --ok:#34d399;
      --bad:#fb7185;
      --warn:#fbbf24;
      --shadow: 0 16px 40px rgba(0,0,0,.35);
      --radius:18px;
      --radius2:14px;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial;
      background:
        radial-gradient(1200px 700px at 10% 10%, rgba(110,231,255,.18), transparent 55%),
        radial-gradient(900px 600px at 90% 20%, rgba(167,139,250,.18), transparent 50%),
        radial-gradient(900px 600px at 40% 90%, rgba(52,211,153,.10), transparent 55%),
        var(--bg);
    }
    a{ color:inherit; }

    .wrap{ max-width:1150px; margin:0 auto; padding:26px 18px 60px; }
    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:14px;
      padding:14px 16px;
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      box-shadow:var(--shadow);
      border-radius:var(--radius);
      position:sticky; top:12px; backdrop-filter: blur(10px);
      z-index:10;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
    }
    .logo{
      width:40px; height:40px; border-radius:14px;
      background:linear-gradient(135deg, rgba(110,231,255,.95), rgba(167,139,250,.90));
      box-shadow: 0 10px 28px rgba(110,231,255,.18);
      display:grid; place-items:center;
      font-weight:900; color:#07101f;
      user-select:none;
    }
    .brand h1{ margin:0; font-size:16px; letter-spacing:.2px; }
    .brand p{ margin:0; font-size:12px; color:var(--muted); }

    .right{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      justify-content:flex-end;
    }
    .pill{
      font-size:12px; color:var(--muted);
      border:1px solid var(--line);
      padding:8px 10px;
      border-radius:999px;
      background:rgba(0,0,0,.15);
    }
    .btn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:9px 12px;
      border-radius:12px;
      cursor:pointer;
      transition:.18s ease;
      font-weight:650;
    }
    .btn:hover{ transform: translateY(-1px); background:rgba(255,255,255,.09); }
    .btn.primary{
      border-color: rgba(110,231,255,.35);
      background: linear-gradient(135deg, rgba(110,231,255,.18), rgba(167,139,250,.14));
    }
    .btn.danger{
      border-color: rgba(251,113,133,.40);
      background: rgba(251,113,133,.12);
    }
    .btn:disabled{ opacity:.55; cursor:not-allowed; transform:none; }

    .grid{
      margin-top:18px;
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:16px;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns:1fr; }
      .topbar{ position:relative; top:0; }
    }

    .card{
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 14px 12px;
      border-bottom:1px solid var(--line);
      background: rgba(255,255,255,.04);
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    .card .hd h2{ margin:0; font-size:14px; }
    .card .hd p{ margin:6px 0 0; font-size:12px; color:var(--muted); line-height:1.4; }
    .card .bd{ padding:14px; }

    .row{ display:flex; gap:10px; }
    .row > *{ flex:1; }
    .field{ display:flex; flex-direction:column; gap:6px; margin-bottom:10px; }
    .field label{ font-size:12px; color:var(--muted); }
    input, select, textarea{
      background: rgba(0,0,0,.22);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px 10px;
      color: var(--text);
      outline:none;
      font-size:14px;
    }
    textarea{ min-height: 84px; resize: vertical; }
    input::placeholder, textarea::placeholder{ color: rgba(234,240,255,.40); }

    .msg{
      margin-top:10px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      padding:10px 10px;
      border-radius: 14px;
      font-size: 13px;
      color: var(--muted);
      line-height:1.4;
    }
    .msg.ok{ border-color: rgba(52,211,153,.35); color: rgba(203,255,231,.90); background: rgba(52,211,153,.10); }
    .msg.bad{ border-color: rgba(251,113,133,.38); color: rgba(255,210,219,.92); background: rgba(251,113,133,.10); }
    .msg.warn{ border-color: rgba(251,191,36,.35); color: rgba(255,244,204,.92); background: rgba(251,191,36,.10); }

    .tabs{
      display:flex; gap:8px; flex-wrap:wrap;
      padding:12px 14px 0;
    }
    .tab{
      border:1px solid var(--line);
      background: rgba(0,0,0,.15);
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      cursor:pointer;
      color: var(--muted);
      user-select:none;
    }
    .tab.active{
      color: var(--text);
      border-color: rgba(110,231,255,.35);
      background: linear-gradient(135deg, rgba(110,231,255,.16), rgba(167,139,250,.12));
    }

    .list{
      display:flex; flex-direction:column; gap:10px;
    }
    .item{
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      border-radius: var(--radius2);
      padding: 12px;
      display:flex; gap:10px; align-items:flex-start; justify-content:space-between;
    }
    .item h3{ margin:0; font-size:13px; }
    .item p{ margin:5px 0 0; font-size:12px; color:var(--muted); line-height:1.35; }
    .item .meta{ font-size:12px; color:var(--muted); }
    .item .actions{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.16);
      color: var(--muted);
      white-space:nowrap;
    }
    .badge.ok{ border-color: rgba(52,211,153,.35); color: rgba(203,255,231,.90); background: rgba(52,211,153,.10); }
    .badge.bad{ border-color: rgba(251,113,133,.38); color: rgba(255,210,219,.92); background: rgba(251,113,133,.10); }
    .badge.warn{ border-color: rgba(251,191,36,.35); color: rgba(255,244,204,.92); background: rgba(251,191,36,.10); }
    .badge.brand{ border-color: rgba(110,231,255,.35); color: rgba(222,250,255,.95); background: rgba(110,231,255,.10); }

    .muted{ color:var(--muted); font-size:12px; }
    .hr{ height:1px; background:var(--line); margin:12px 0; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">WH</div>
        <div>
          <h1>WorkHub</h1>
          <p>Businesses ‚áÑ Workers ‚Ä¢ Vizag-first ‚Ä¢ Simple & fast</p>
        </div>
      </div>

      <div class="right">
        <div class="pill" id="healthPill">API: checking‚Ä¶</div>
        <div class="pill" id="whoPill">Not logged in</div>
        <button class="btn" id="btnRefresh">Refresh</button>
        <button class="btn danger" id="btnLogout" disabled>Logout</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: Auth + Profile -->
      <div class="card">
        <div class="hd">
          <div>
            <h2>Account</h2>
            <p>Login or create an account. Owner & Worker supported.</p>
          </div>
        </div>

        <div class="tabs">
          <div class="tab active" data-tab="login">Login</div>
          <div class="tab" data-tab="register">Register</div>
          <div class="tab" data-tab="profile">Worker Profile</div>
          <div class="tab" data-tab="owner">Owner Panel</div>
        </div>

        <div class="bd">
          <!-- LOGIN -->
          <div class="panel" id="panel-login">
            <div class="field">
              <label>Email</label>
              <input id="loginEmail" placeholder="name@example.com" />
            </div>
            <div class="field">
              <label>Password</label>
              <input id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
            </div>
            <button class="btn primary" id="btnLogin">Login</button>
            <div class="msg" id="loginMsg" style="display:none;"></div>

            <div class="hr"></div>
            <div class="muted">
              Admin test login (seeded by backend): <b>admin@workhub.local</b> / <b>admin123</b>
            </div>
          </div>

          <!-- REGISTER -->
          <div class="panel" id="panel-register" style="display:none;">
            <div class="field">
              <label>Role</label>
              <select id="regRole">
                <option value="owner">Business Owner</option>
                <option value="worker">Worker</option>
              </select>
            </div>
            <div class="field">
              <label>Name</label>
              <input id="regName" placeholder="Full name" />
            </div>
            <div class="row">
              <div class="field">
                <label>Email</label>
                <input id="regEmail" placeholder="name@example.com" />
              </div>
              <div class="field">
                <label>Phone (optional)</label>
                <input id="regPhone" placeholder="98765‚Ä¶" />
              </div>
            </div>
            <div class="field">
              <label>Password</label>
              <input id="regPass" type="password" placeholder="Minimum 4 characters" />
            </div>
            <button class="btn primary" id="btnRegister">Create account</button>
            <div class="msg" id="regMsg" style="display:none;"></div>
          </div>

          <!-- WORKER PROFILE -->
          <div class="panel" id="panel-profile" style="display:none;">
            <div class="muted" style="margin-bottom:10px;">
              Only for <b>Worker</b> accounts. Create/update your skills and status.
            </div>

            <div class="field">
              <label>Skills (comma separated)</label>
              <input id="wpSkills" placeholder="Plumber, Electrician, Painter‚Ä¶" />
            </div>
            <div class="row">
              <div class="field">
                <label>Experience (years)</label>
                <input id="wpExp" type="number" min="0" value="0" />
              </div>
              <div class="field">
                <label>Location</label>
                <input id="wpLoc" placeholder="Vizag / Gajuwaka / MVP‚Ä¶" />
              </div>
            </div>

            <button class="btn primary" id="btnSaveProfile">Save profile</button>

            <div class="hr"></div>

            <div class="field">
              <label>Availability status</label>
              <select id="wpStatus">
                <option value="pending">Pending</option>
                <option value="ready">Ready</option>
                <option value="busy">Busy</option>
              </select>
            </div>
            <button class="btn" id="btnSetStatus">Update status</button>

            <div class="msg" id="wpMsg" style="display:none;"></div>
          </div>

          <!-- OWNER PANEL -->
          <div class="panel" id="panel-owner" style="display:none;">
            <div class="muted" style="margin-bottom:10px;">
              Only for <b>Owner</b> accounts. Create businesses and approve worker requests.
            </div>

            <div class="field">
              <label>Business name</label>
              <input id="bizName" placeholder="e.g., Sri Lakshmi Constructions" />
            </div>
            <div class="row">
              <div class="field">
                <label>Category</label>
                <input id="bizCat" placeholder="Construction / Hotel / Retail‚Ä¶" />
              </div>
              <div class="field">
                <label>Location</label>
                <input id="bizLoc" placeholder="Vizag" />
              </div>
            </div>
            <button class="btn primary" id="btnCreateBiz">Create business</button>

            <div class="hr"></div>

            <button class="btn" id="btnLoadRequests">Load pending requests</button>
            <div class="msg" id="ownerMsg" style="display:none;"></div>

            <div class="hr"></div>
            <div class="list" id="requestList"></div>
          </div>
        </div>
      </div>

      <!-- RIGHT: Browse -->
      <div class="card">
        <div class="hd">
          <div>
            <h2>Browse</h2>
            <p>See businesses and workers. Workers can request to join a business.</p>
          </div>
          <div class="badge brand" id="countBadge">0 items</div>
        </div>

        <div class="bd">
          <div class="row">
            <button class="btn primary" id="btnBusinesses">Businesses</button>
            <button class="btn" id="btnWorkers">Workers</button>
          </div>

          <div class="hr"></div>

          <!-- Filters -->
          <div class="row" style="align-items:flex-end;">
            <div class="field" style="margin:0;">
              <label>Business filter (for workers)</label>
              <select id="filterBusiness">
                <option value="">All businesses</option>
              </select>
            </div>
            <div class="field" style="margin:0;">
              <label>Status filter</label>
              <select id="filterStatus">
                <option value="">All</option>
                <option value="ready">Ready</option>
                <option value="busy">Busy</option>
                <option value="pending">Pending</option>
              </select>
            </div>
          </div>

          <div class="hr"></div>
          <div class="list" id="list"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ====== API helper ======
    const api = (path, opts={}) =>
      fetch(path, { headers: { "Content-Type": "application/json" }, ...opts })
        .then(async r => {
          const data = await r.json().catch(() => ({}));
          if (!r.ok) throw new Error(data.error || ("Request failed: " + r.status));
          return data;
        });

    const el = id => document.getElementById(id);

    // ====== State ======
    const state = {
      user: null,
      view: "businesses", // businesses | workers
      businesses: [],
    };

    function setMsg(target, text, type="") {
      const box = el(target);
      box.style.display = "block";
      box.className = "msg " + (type || "");
      box.textContent = text;
    }
    function hideMsg(target){
      const box = el(target);
      box.style.display = "none";
      box.textContent = "";
      box.className = "msg";
    }

    function roleName(role){
      if (role === "admin") return "Admin";
      if (role === "owner") return "Owner";
      if (role === "worker") return "Worker";
      return role;
    }

    function updateTop() {
      el("btnLogout").disabled = !state.user;
      el("whoPill").textContent = state.user
        ? `${roleName(state.user.role)} ‚Ä¢ ${state.user.name} (id:${state.user.id})`
        : "Not logged in";
    }

    // ====== Tabs ======
    function showTab(key){
      document.querySelectorAll(".tab").forEach(t => {
        t.classList.toggle("active", t.dataset.tab === key);
      });
      ["login","register","profile","owner"].forEach(k => {
        el("panel-"+k).style.display = (k === key) ? "block" : "none";
      });
    }
    document.querySelectorAll(".tab").forEach(t => {
      t.addEventListener("click", () => showTab(t.dataset.tab));
    });

    // ====== Health ======
    async function checkHealth(){
      try{
        await api("/api/health");
        el("healthPill").textContent = "API: OK";
      }catch(e){
        el("healthPill").textContent = "API: DOWN";
      }
    }

    // ====== Auth ======
    el("btnLogin").addEventListener("click", async () => {
      hideMsg("loginMsg");
      try{
        const email = el("loginEmail").value.trim();
        const password = el("loginPass").value;
        const data = await api("/api/login", {
          method:"POST",
          body: JSON.stringify({ email, password })
        });
        state.user = data.user;
        setMsg("loginMsg", "Logged in successfully.", "ok");
        updateTop();
        // default tab by role
        if (state.user.role === "owner") showTab("owner");
        else if (state.user.role === "worker") showTab("profile");
        else showTab("login");
        await refreshAll();
      }catch(e){
        setMsg("loginMsg", e.message, "bad");
      }
    });

    el("btnRegister").addEventListener("click", async () => {
      hideMsg("regMsg");
      try{
        const role = el("regRole").value;
        const name = el("regName").value.trim();
        const email = el("regEmail").value.trim();
        const phone = el("regPhone").value.trim();
        const password = el("regPass").value;

        const data = await api("/api/register", {
          method:"POST",
          body: JSON.stringify({ role, name, email, phone, password })
        });

        setMsg("regMsg", `Account created for ${data.user.name}. Now login.`, "ok");
      }catch(e){
        setMsg("regMsg", e.message, "bad");
      }
    });

    el("btnLogout").addEventListener("click", () => {
      state.user = null;
      updateTop();
      showTab("login");
      refreshAll();
    });

    // ====== Worker profile ======
    el("btnSaveProfile").addEventListener("click", async () => {
      hideMsg("wpMsg");
      try{
        if (!state.user || state.user.role !== "worker") throw new Error("Login as a Worker first.");
        const skills = el("wpSkills").value.trim();
        const experience_years = Number(el("wpExp").value || 0);
        const location = el("wpLoc").value.trim();

        await api("/api/worker/profile", {
          method:"POST",
          body: JSON.stringify({ user_id: state.user.id, skills, experience_years, location })
        });

        setMsg("wpMsg", "Profile saved.", "ok");
        await refreshWorkers();
      }catch(e){
        setMsg("wpMsg", e.message, "bad");
      }
    });

    el("btnSetStatus").addEventListener("click", async () => {
      hideMsg("wpMsg");
      try{
        if (!state.user || state.user.role !== "worker") throw new Error("Login as a Worker first.");
        const status = el("wpStatus").value;
        await api("/api/worker/status", {
          method:"POST",
          body: JSON.stringify({ user_id: state.user.id, status })
        });
        setMsg("wpMsg", "Status updated.", "ok");
        await refreshWorkers();
      }catch(e){
        setMsg("wpMsg", e.message, "bad");
      }
    });

    // ====== Owner panel ======
    el("btnCreateBiz").addEventListener("click", async () => {
      hideMsg("ownerMsg");
      try{
        if (!state.user || state.user.role !== "owner") throw new Error("Login as an Owner first.");
        const name = el("bizName").value.trim();
        const category = el("bizCat").value.trim();
        const location = el("bizLoc").value.trim();

        const data = await api("/api/owner/businesses", {
          method:"POST",
          body: JSON.stringify({ owner_id: state.user.id, name, category, location })
        });

        setMsg("ownerMsg", `Business created: ${data.business.name}`, "ok");
        el("bizName").value = "";
        await refreshBusinesses();
        if (state.view === "businesses") renderBusinesses();
      }catch(e){
        setMsg("ownerMsg", e.message, "bad");
      }
    });

    el("btnLoadRequests").addEventListener("click", async () => {
      hideMsg("ownerMsg");
      try{
        if (!state.user || state.user.role !== "owner") throw new Error("Login as an Owner first.");
        const data = await api(`/api/owner/pending_requests?owner_id=${state.user.id}`);
        renderRequests(data.items || []);
        setMsg("ownerMsg", `Loaded ${data.items.length} pending request(s).`, "ok");
      }catch(e){
        setMsg("ownerMsg", e.message, "bad");
      }
    });

    function renderRequests(items){
      const box = el("requestList");
      box.innerHTML = "";
      if (!items.length){
        box.innerHTML = `<div class="muted">No pending requests.</div>`;
        return;
      }
      items.forEach(it => {
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <div>
            <h3>${it.worker_name} <span class="badge warn">Pending</span></h3>
            <p>
              Business: <b>${it.business_name}</b><br/>
              Email: ${it.email || "-"} ‚Ä¢ Phone: ${it.phone || "-"}
            </p>
          </div>
          <div class="actions">
            <button class="btn primary" data-approve="${it.request_id}">Approve</button>
          </div>
        `;
        box.appendChild(div);
      });

      box.querySelectorAll("[data-approve]").forEach(btn => {
        btn.addEventListener("click", async () => {
          try{
            btn.disabled = true;
            const request_id = Number(btn.dataset.approve);
            await api("/api/owner/approve_request", {
              method:"POST",
              body: JSON.stringify({ owner_id: state.user.id, request_id })
            });
            setMsg("ownerMsg", "Request approved.", "ok");
            // refresh list
            const data = await api(`/api/owner/pending_requests?owner_id=${state.user.id}`);
            renderRequests(data.items || []);
          }catch(e){
            setMsg("ownerMsg", e.message, "bad");
          }finally{
            btn.disabled = false;
          }
        });
      });
    }

    // ====== Browse view buttons ======
    el("btnBusinesses").addEventListener("click", async () => {
      state.view = "businesses";
      await refreshBusinesses();
      renderBusinesses();
    });
    el("btnWorkers").addEventListener("click", async () => {
      state.view = "workers";
      await refreshWorkers();
    });

    el("btnRefresh").addEventListener("click", refreshAll);

    // ====== Filters ======
    el("filterBusiness").addEventListener("change", () => {
      if (state.view === "workers") refreshWorkers();
    });
    el("filterStatus").addEventListener("change", () => {
      if (state.view === "workers") refreshWorkers();
    });

    // ====== Render Businesses ======
    async function refreshBusinesses(){
      const data = await api("/api/businesses");
      state.businesses = data.items || [];
      // update business dropdown
      const sel = el("filterBusiness");
      const keep = sel.value;
      sel.innerHTML = `<option value="">All businesses</option>` + state.businesses.map(b =>
        `<option value="${b.id}">${escapeHtml(b.name)} ‚Ä¢ ${escapeHtml(b.location || "‚Äî")}</option>`
      ).join("");
      sel.value = keep || "";
    }

    function renderBusinesses(){
      const box = el("list");
      box.innerHTML = "";
      const items = state.businesses;

      el("countBadge").textContent = `${items.length} businesses`;

      if (!items.length){
        box.innerHTML = `<div class="muted">No businesses yet. Create one as an Owner.</div>`;
        return;
      }

      items.forEach(b => {
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <div>
            <h3>${escapeHtml(b.name)}</h3>
            <p>
              Category: ${escapeHtml(b.category || "‚Äî")}<br/>
              Location: ${escapeHtml(b.location || "‚Äî")}<br/>
              Owner: ${escapeHtml(b.owner_name || "‚Äî")}
            </p>
          </div>
          <div class="actions">
            ${state.user && state.user.role === "worker"
              ? `<button class="btn primary" data-join="${b.id}">Request to Join</button>`
              : `<span class="badge brand">Business</span>`
            }
          </div>
        `;
        box.appendChild(div);
      });

      box.querySelectorAll("[data-join]").forEach(btn => {
        btn.addEventListener("click", async () => {
          try{
            if (!state.user || state.user.role !== "worker") throw new Error("Login as a Worker first.");
            btn.disabled = true;
            const business_id = Number(btn.dataset.join);
            await api("/api/worker/register_business", {
              method:"POST",
              body: JSON.stringify({ worker_user_id: state.user.id, business_id })
            });
            alert("Request sent to owner for approval.");
          }catch(e){
            alert(e.message);
          }finally{
            btn.disabled = false;
          }
        });
      });
    }

    // ====== Render Workers ======
    async function refreshWorkers(){
      const box = el("list");
      box.innerHTML = `<div class="muted">Loading workers‚Ä¶</div>`;

      const status = el("filterStatus").value;
      const business_id = el("filterBusiness").value;

      const qs = new URLSearchParams();
      if (status) qs.set("status", status);
      if (business_id) qs.set("business_id", business_id);

      try{
        const data = await api(`/api/workers?${qs.toString()}`);
        const items = data.items || [];
        el("countBadge").textContent = `${items.length} workers`;
        renderWorkers(items);
      }catch(e){
        box.innerHTML = `<div class="msg bad">${escapeHtml(e.message)}</div>`;
      }
    }

    function statusBadge(s){
      if (s === "ready") return `<span class="badge ok">Ready</span>`;
      if (s === "busy") return `<span class="badge bad">Busy</span>`;
      return `<span class="badge warn">Pending</span>`;
    }

    function renderWorkers(items){
      const box = el("list");
      box.innerHTML = "";

      if (!items.length){
        box.innerHTML = `<div class="muted">No workers found for current filters.</div>`;
        return;
      }

      items.forEach(w => {
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <div>
            <h3>${escapeHtml(w.name)} ${statusBadge(w.status)}</h3>
            <p>
              Skills: ${escapeHtml(w.skills || "‚Äî")}<br/>
              Exp: ${escapeHtml(String(w.experience_years ?? 0))} yrs ‚Ä¢ Location: ${escapeHtml(w.location || "‚Äî")}<br/>
              Rating: <b>${escapeHtml(String(w.avg_rating))}</b> (${escapeHtml(String(w.rating_count))})
            </p>
          </div>
          <div class="actions">
            <span class="badge">üìû ${escapeHtml(w.phone || "‚Äî")}</span>
            <span class="badge">‚úâÔ∏è ${escapeHtml(w.email || "‚Äî")}</span>
          </div>
        `;
        box.appendChild(div);
      });
    }

    // ====== Utils ======
    function escapeHtml(str){
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    async function refreshAll(){
      await checkHealth();
      await refreshBusinesses();
      if (state.view === "businesses") renderBusinesses();
      else await refreshWorkers();
      updateTop();
    }

    // ====== Boot ======
    (async function init(){
      await refreshAll();
      state.view = "businesses";
    })();
  </script>
</body>
</html>
